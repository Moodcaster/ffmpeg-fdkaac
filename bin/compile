#!/bin/sh


indent() {
  sed 's/^/       /'
}

PROFILE_PATH="$1/.profile.d/ffmpeg.sh"

echo "exporting PATH and LIBRARY_PATH" | indent
mkdir -p $(dirname $PROFILE_PATH)

echo 'export PATH="$PATH:$HOME/vendor/bin"' >> $PROFILE_PATH
echo 'export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$HOME/vendor/lib"' >> $PROFILE_PATH

mkdir -p "$1/vendor"
export BUILD_DIR=$1"/vendor"
export CACHE_DIR=$2


echo "-----> Starting buildpack"

apt-get update
apt-get -y install autoconf automake build-essential git-core libass-dev libgpac-dev libsdl1.2-dev libtheora-dev libtool libvdpau-dev libvorbis-dev libx11-dev libxext-dev libxfixes-dev pkg-config texi2html zlib1g-dev libmp3lame-dev nasm gcc yasm libx264-dev && true

echo "-----> Creating sources dir"

mkdir -p $BUILD_DIR/ffmpeg_sources
cd $BUILD_DIR/ffmpeg_sources

echo "-----> Getting fdk-aac encoder"

git clone --depth 1 git://github.com/mstorsjo/fdk-aac.git

echo "-----> Installing fdk-aac encoder"

cd fdk-aac
autoreconf -fiv
./configure --prefix="$BUILD_DIR" --disable-shared
make
make install
make distclean

echo "-----> Getting newest yasm"

cd $BUILD_DIR
wget http://www.tortall.net/projects/yasm/releases/yasm-1.3.0.tar.gz
tar -xvf yasm-1.3.0.tar.gz

echo "-----> Configure Yasm"

cd yasm-1.3.0
./configure --prefix="$BUILD_DIR" --disable-debug >/dev/null 2>&1
make
make install >/dev/null 2>&1
make distclean > /dev/null 2>&1

echo "-----> Getting lame"

cd $BUILD_DIR/ffmpeg_sources
wget http://downloads.sourceforge.net/project/lame/lame/3.99/lame-3.99.5.tar.gz
tar xzvf lame-3.99.5.tar.gz

echo "-----> Installing lame"

cd lame-3.99.5
./configure --prefix="$BUILD_DIR" --enable-nasm --disable-shared
make
make install
make distclean

echo "-----> Getting ffmpeg"

cd $BUILD_DIR/ffmpeg_sources
git clone --depth 1 git://source.ffmpeg.org/ffmpeg

echo "-----> Installing ffmpeg"

cd ffmpeg
PKG_CONFIG_PATH="$BUILD_DIR/vendor/lib/pkgconfig"
export PKG_CONFIG_PATH

echo "-----> Configure ffmpeg"

./configure --prefix="$BUILD_DIR" \
  --extra-cflags="-I$BUILD_DIR/include" --extra-ldflags="-L$BUILD_DIR/lib" \
  --prefix="$BUILD_DIR" --extra-libs="-ldl" --enable-gpl --enable-libass --enable-libfdk-aac --enable-libx264 \
  --enable-libmp3lame --enable-nonfree
make
make install

echo "-----> Copy binary"

mkdir -p $BUILD_DIR/vendor
cp ffmpeg $BUILD_DIR/vendor/
make distclean
hash -r
ffmpeg 2>&1 | head -n1
