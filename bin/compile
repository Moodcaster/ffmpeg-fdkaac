#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2

echo "-----> Starting buildpack"

sudo apt-get update
sudo apt-get -y install autoconf automake build-essential git-core libass-dev libgpac-dev libsdl1.2-dev libtheora-dev libtool libvdpau-dev libvorbis-dev libx11-dev libxext-dev libxfixes-dev pkg-config texi2html zlib1g-dev libmp3lame-dev nasm gcc yasm libx264-dev && true

echo "-----> Creating sources dir"

mkdir -p $CACHE_DIR/ffmpeg_sources
cd $CACHE_DIR/ffmpeg_sources

echo "-----> Getting fdk-aac encoder"

git clone --depth 1 git://github.com/mstorsjo/fdk-aac.git

echo "-----> Installing fdk-aac encoder"

cd fdk-aac
autoreconf -fiv
./configure --prefix="$CACHE_DIR/ffmpeg_build" --disable-shared
make
make install
make distclean

# echo "-----> Getting lame"

# cd $CACHE_DIR/ffmpeg_sources
# wget http://downloads.sourceforge.net/project/lame/lame/3.99/lame-3.99.5.tar.gz
# tar xzvf lame-3.99.5.tar.gz

# echo "-----> Installing lame"

# cd lame-3.99.5
# ./configure --prefix="$CACHE_DIR/ffmpeg_build" --enable-nasm --disable-shared
# make
# make install
# make distclean

echo "-----> Getting newest yasm"

cd $CACHE_DIR
wget http://www.tortall.net/projects/yasm/releases/yasm-1.3.0.tar.gz
tar -xvf yasm-1.3.0.tar.gz

echo "-----> Configure Yasm"

cd yasm-1.3.0
./configure --prefix="$CACHE_DIR/ffmpeg_build" --bindir="$CACHE_DIR/bin"
make
make install
make distclean

echo "-----> Getting ffmpeg"

cd $CACHE_DIR/ffmpeg_sources
git clone --depth 1 git://source.ffmpeg.org/ffmpeg

echo "-----> Installing ffmpeg"

cd ffmpeg
PKG_CONFIG_PATH="$CACHE_DIR/ffmpeg_build/lib/pkgconfig"
export PKG_CONFIG_PATH

echo "-----> Configure ffmpeg"

./configure --prefix="$CACHE_DIR/ffmpeg_build" \
  --extra-cflags="-I$CACHE_DIR/ffmpeg_build/include" --extra-ldflags="-L$CACHE_DIR/ffmpeg_build/lib" \
  --bindir="$CACHE_DIR/bin" --extra-libs="-ldl" --enable-gpl --enable-libass --enable-libfdk-aac --enable-libx264 \
  --enable-libmp3lame --enable-nonfree
make
make install

echo "-----> Copy binary"

mkdir -p $BUILD_DIR/vendor
sudo cp ffmpeg $BUILD_DIR/vendor/
make distclean
hash -r
ffmpeg 2>&1 | head -n1
